---
title: ğŸ‘“ ä»æºç ç¼–è¯‘ OpenCV å¹¶æ‰“åŒ…åˆ° Docker é•œåƒçš„å…¨è¿‡ç¨‹
date: 2024-11-27
tags:
- OpenCV
- Docker
summary: è¦åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²è‡ªç¼–è¯‘çš„ OpenCV æœåŠ¡ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ç”¨ Docker æ‰“åŒ…æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„é•œåƒå¹¶å‘å¸ƒåˆ°æœåŠ¡å™¨ã€‚è¿‡ç¨‹å®åœ¨æŒºå¤æ‚çš„åšä¸ªè®°å½•ã€‚
draft: false
---

ç›®å‰åœ¨åšçš„æœ‰ä¸ªé¡¹ç›®ï¼Œå› ä¸ºä¸€äº›åŸå› ï¼Œéœ€è¦åœ¨ Debian ç¯å¢ƒçš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²è‡ªç¼–è¯‘çš„ OpenCV æœåŠ¡å¹¶ä¸”é›†æˆåˆ°ä¸€ä¸ª Python é¡¹ç›®ä¸­ã€‚è®°å½•ä¸€ä¸‹å…·ä½“è¿‡ç¨‹ã€‚

ç”¨åˆ°çš„æŠ€æœ¯æ–¹æ¡ˆæœ‰ï¼š
- OpenCV æºä»£ç 
- Docker
- Poetry
- Python 3.11

æœ¬æ–‡ä»…ä»‹ç» opencv å’Œ opencv-contrib åŒ…çš„æºç ç¼–è¯‘å¹¶æ‰“åŒ…åˆ° Dockerã€‚ä¸æ¶‰åŠ GPU éƒ¨åˆ†ï¼Œå¦‚æœä½ éœ€è¦å¼€å¯ GPU åŠŸèƒ½ï¼Œè¯·å‚è€ƒå…¶ä»–æ–‡ç« ã€‚

å¦å¤–ï¼Œæœ¬æ–‡é»˜è®¤è¯»è€…äº†è§£ Dockerï¼ŒPoetry ç­‰åŸºç¡€çŸ¥è¯†ã€‚ç›¸å…³æŠ€æœ¯æ ˆä¸å¦å¤–ä»‹ç»ã€‚

## ä½¿ç”¨ Dockerfile æ‰“åŒ… opencv ä¾èµ–

ç›¸å…³çš„ Dockerfile æˆ‘æ”¾åœ¨ä»¥ä¸‹çš„ repo ä¸­ï¼Œä½¿ç”¨æ–¹å¼å·²ç»å†™åœ¨ repo çš„ readme é‡Œã€‚

[hansenz42/docker-opencv-poetry-base: Dockerfile and script for building OpenCV image from source code. including opencv+opencv-contrib+poetry.](https://github.com/hansenz42/docker-opencv-poetry-base)

docker build å®Œæˆåå°±å¾—åˆ°äº†ä¸€ä¸ªåä¸º `opencv-python-base:latest` çš„åŸºç¡€é•œåƒã€‚

### ä½¿ç”¨ opencv åŸºç¡€é•œåƒ

åœ¨éœ€è¦å¼•å…¥ OpenCV çš„é¡¹ç›®ä¸­ï¼Œä¿®æ”¹ `pyproject.toml` æ·»åŠ å¦‚ä¸‹ä¾èµ–:

```toml
[tool.poetry.dependencies]
opencv = {path = "/app/lib/opencv/build/python_loader", develop = true}
```

åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º `Dockerfile`ï¼Œå‚è€ƒä»¥ä¸‹æ¨¡æ¿ï¼š

```dockerfile
FROM opencv-python-base:latest

# å®‰è£… poetry
RUN pip3 install poetry

# åˆ›å»ºç›®å½•ï¼Œæ‹·è´ pyproject.toml é¡¹ç›®è¯´æ˜æ–‡ä»¶
WORKDIR /app
COPY pyproject.toml /app/pyproject.toml

# å®‰è£…é¡¹ç›®ä¾èµ–
RUN poetry config virtualenvs.create false && \
    poetry install --with release --without dev --no-interaction --no-ansi --no-root

# æ‹·è´ä»£ç æºæ–‡ä»¶
COPY . /app

# æŒ‡å®šå®¹å™¨çš„å¼€æ”¾ç«¯å£
EXPOSE 8080

# æŒ‡å®šç¨‹åºçš„è¿è¡Œå…¥å£
CMD poetry run python3 main.py
```

æ¥ä¸‹æ¥å°±ç”¨ä½ è‡ªå·±çš„æ–¹å¼æ‰“åŒ…é¡¹ç›®é•œåƒï¼Œå°±å¯ä»¥ä½¿ç”¨ opencv äº†ã€‚

```bash
docker build . -t my-opencv-project
```

## æœ¬åœ°ç¼–è¯‘çš„è¯•éªŒè¿‡ç¨‹

ä»¥ä¸‹æ˜¯æˆ‘åœ¨æœ¬åœ°ç”¨ Debian ç¯å¢ƒè¯•éªŒç¼–è¯‘ OpenCV çš„è¿‡ç¨‹ï¼Œç•™ä½œå‚è€ƒã€‚

å¦‚æœä½ è¦ç›´æ¥ç¼–è¯‘ OpenCV é•œåƒï¼Œç”¨å‰ä¸€ç«  github çš„æ–¹æ¡ˆå³å¯ã€‚

### è·å–èµ„æº

ä» OpenCV çš„ GitHub ä¸Šä¸‹è½½éœ€è¦çš„æºç åŒ…ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°äº† opencv å’Œ opencv-contrib åŒ…ã€‚

- opencv: [opencv/opencv: Open Source Computer Vision Library](https://github.com/opencv/opencv)
- opencv-contrib: [opencv/opencv_contrib at 4.10.0](https://github.com/opencv/opencv_contrib/tree/4.10.0)

å½“ç„¶ä¹Ÿå¯ç›´æ¥ç”¨å‘½ä»¤è¡Œä¸‹è½½ï¼š

```bash
wget -O opencv-4.10.0.tar.gz https://github.com/opencv/opencv/archive/refs/tags/4.10.0.tar.gz
wget -O opencv_contrib-4.10.0.tar.gz https://github.com/opencv/opencv_contrib/archive/refs/tags/4.10.0.tar.gz
```

ä¸‹è½½çš„ç‰ˆæœ¬ä¸º 4.10.0ï¼Œå¦‚æœæœ‰æ›´æ–°ç‰ˆæœ¬ï¼Œè¯·å…³æ³¨ä»¥ä¸Š Github ä¸»é¡µã€‚

å°†ä¸‹è½½åˆ°å¥½çš„ä¸¤ä¸ªæ–‡ä»¶è§£å‹å¹¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚

```bash
tar -xvf opencv-4.10.0.tar.gz
tar -xvf opencv_contrib-4.10.0.tar.gz
```

### ç¯å¢ƒå‡†å¤‡

å¦‚æœåœ¨ debian ç¯å¢ƒä¸‹ï¼Œæ³¨æ„ä»¥ä¸‹çš„ä¾èµ–ï¼Œå…¶ä»–ç¯å¢ƒç±»ä¼¼

```bash
sudo apt install build-essential cmake git pkg-config libgtk-3-dev \
libavcodec-dev libavformat-dev libswscale-dev libv4l-dev \
libxvidcore-dev libx264-dev libjpeg-dev libpng-dev libtiff-dev \
gfortran openexr libatlas-base-dev \
libtbb-dev libopenexr-dev \
libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev
```

å¦å¤–è¿˜éœ€è¦ç¡®è®¤ Python çš„ç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ 3.11ã€‚å¦å¤–è¿˜éœ€è¦ç¡®è®¤å½“å‰çš„ Python ç¯å¢ƒå·²å®‰è£…äº† numpyã€‚

å¦‚æœä½ ä½¿ç”¨æˆ‘æä¾›çš„ Dockerfile ç›´æ¥æ‰“åŒ…ï¼Œåˆ™ä¸å­˜åœ¨ Python ç¯å¢ƒçš„é—®é¢˜ï¼Œåªæœ‰åœ¨è‡ªå·±ç”µè„‘ç”¨æœ¬åœ°ç¯å¢ƒç¼–è¯‘çš„æ—¶å€™éœ€è¦æ³¨æ„ã€‚

### ç¼–è¯‘å’Œå®‰è£…

```bash
# åˆ‡æ¢åˆ°ç›®å½•å¹¶æ–°å»ºæ–‡ä»¶å¤¹ build
cd opencv-4.10.0
mkdir build
cd build

cmake \
-D CMAKE_BUILD_TYPE=Release \
-D OPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-4.10.0/modules \
-D OPENCV_ENABLE_NONFREE=ON \
-D BUILD_EXAMPLES=ON \
-D CMAKE_INSTALL_PREFIX=/usr/local \
-D BUILD_DOCS=ON \
-D BUILD_TESTS=ON \
-D BUILD_PERF_TESTS=ON \
-D BUILD_opencv_python2=OFF \
-D BUILD_opencv_python3=ON \
-D PYTHON3_EXECUTABLE=$(which python3) \
-D PYTHON3_INCLUDE_DIR=$(python3 -c "from distutils.sysconfig import get_python_inc; print(get_python_inc())") \
-D PYTHON3_PACKAGES_PATH=$(python3 -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())") \
..
```

cmake å®Œæˆåï¼Œç¡®è®¤ä¸€ä¸‹è¾“å‡ºçš„å†…å®¹ï¼Œç€é‡çœ‹ Python ç¯å¢ƒæ˜¯å¦å·²ç»é…ç½®æ­£ç¡®ï¼Œå¦‚ä¸‹ï¼š

```bash
--   Python 3:
--     Interpreter:                 /Users/username/.pyenv/shims/python3 (ver 3.11.10)
--     Libraries:                   /Library/Frameworks/Python.framework/Versions/3.11/lib/libpython3.11.dylib (ver 3.11.10)
--     Limited API:                 NO
--     numpy:                       /Users/username/.pyenv/versions/3.11.10/lib/python3.11/site-packages/numpy/_core/include (ver 2.1.3)
--     install path:                /Users/username/.pyenv/versions/3.11.10/lib/python3.11/site-packages/cv2/python-3.11
--
--   Python (for build):            /Users/username/.pyenv/shims/python3
```

å¦‚æœè¿™é‡Œå‡ºç°å¾ˆå¤š Noï¼Œå°±è¦æ’æŸ¥æ˜¯å¦æ˜¯æœ¬åœ° Python ç¯å¢ƒæœ‰é—®é¢˜ï¼Œæ˜¯å¦å·²ç»å®‰è£… numpyã€‚

æ¥ä¸‹æ¥å¼€å§‹ç¼–è¯‘

```bash
# æ­¤å¤„ -j åé¢çš„å‚æ•°å¯ä»¥æ ¹æ®ä½ çš„ CPU æ ¸å¿ƒæ•°ç›®å†³å®šï¼Œæˆ‘è¿™é‡Œä½¿ç”¨äº† 4ï¼Œä½¿ç”¨æ›´å¥½çš„ CPU å¯ä»¥æå‡åˆ° 8 ç”šè‡³ 12
make -j4
make install
```
å¦‚æœåˆ°ç›®å‰ä¸ºæ­¢æ²¡æœ‰é—®é¢˜ï¼Œæ­¤æ—¶ OpenCV å·²ç»å®‰è£…åˆ°äº†å½“å‰çš„ç³»ç»Ÿçš„ Python ç¯å¢ƒä¸­ã€‚
